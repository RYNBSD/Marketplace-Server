import{a as K,b as Y,c as S,d as A,e as Lt,f as dt,g as P,h as Gr}from"./chunk-2KA3OADR.js";import wt from"express";import Vs from"compression";import bc from"hpp";import Cc from"express-session";import Dc from"morgan";import xc from"helmet";import Lc from"connect-timeout";import _c from"method-override";import Fc from"cookie-parser";import Gc from"cors";import Vc from"response-time";import vc from"request-ip";import{StatusCodes as Ms}from"http-status-codes";import Mc from"cookie-encrypter";import qc from"path";import{randomBytes as So,createCipheriv as ka,createDecipheriv as ja}from"node:crypto";var Gt={};K(Gt,{Category:()=>Qs,CategoryViewer:()=>$s,Order:()=>aa,Product:()=>Js,ProductColor:()=>ta,ProductImage:()=>Zs,ProductInfo:()=>Ws,ProductRating:()=>Xs,ProductSize:()=>ea,ProductTag:()=>sa,ProductViewer:()=>ra,ResponseTime:()=>ia,ServerError:()=>na,Store:()=>ks,StoreLink:()=>zs,StoreSetting:()=>js,StoreViewer:()=>Hs,Tag:()=>oa,User:()=>Bs,UserSetting:()=>Ys});import{z as d}from"zod";var ee=d.object({id:d.number()}),_e=d.object({id:d.string().uuid()}).strict(),ut=d.object({userId:d.string().uuid()}).strict(),_t=d.object({userId:d.string().uuid().nullable()}).strict(),ke=d.object({storeId:d.string().uuid()}).strict(),Vr=d.object({categoryId:d.string().uuid()}).strict(),me=d.object({productId:d.string().uuid()}).strict(),Ks=d.object({tagId:d.string().uuid()}).strict(),Ft=d.object({ip:d.string().nullable()}).strict(),Bs=d.object({username:d.string(),email:d.string(),emailVerified:d.date().nullable(),password:d.string(),image:d.string()}).merge(_e).strict(),Ys=d.object({theme:d.enum(P.THEMES),locale:d.enum(P.LOCALE),forceTheme:d.boolean(),disableAnimations:d.boolean()}).merge(ut).strict(),ks=d.object({name:d.string(),image:d.string()}).merge(_e).merge(ut).strict(),js=d.object({}).merge(ke).strict(),zs=d.object({platform:d.enum(P.PLATFORMS),link:d.string().url()}).merge(_e).merge(ke).strict(),Hs=d.object({}).merge(ee).merge(ke).merge(_t).merge(Ft).strict(),Qs=d.object({name:d.string(),nameAr:d.string(),image:d.string()}).merge(_e).merge(ke).strict(),$s=d.object({}).merge(ee).merge(Vr).merge(_t).merge(Ft).strict(),Js=d.object({title:d.string(),titleAr:d.string(),description:d.string().nullable(),descriptionAr:d.string().nullable(),quality:d.enum(P.QUALITY),stock:d.number(),model:d.string().nullable(),price:d.number(),discount:d.number()}).merge(_e).merge(Vr).strict(),Ws=d.object({info:d.string(),infoAr:d.string()}).merge(ee).merge(me).strict(),Zs=d.object({image:d.string()}).merge(ee).merge(me).strict(),Xs=d.object({rate:d.enum(P.RATING_STARS),comment:d.string()}).merge(ut).merge(me).strict(),ea=d.object({size:d.string()}).merge(ee).merge(me).strict(),ta=d.object({color:d.string()}).merge(ee).merge(me).strict(),ra=d.object({}).merge(ee).merge(me).merge(_t).merge(Ft).strict(),oa=d.object({tag:d.string()}).merge(_e).merge(ke).strict(),sa=d.object({}).merge(me).merge(Ks).strict(),aa=d.object({quantity:d.number(),totalPrice:d.number(),status:d.enum(P.ORDER_STATUS),processedAt:d.date().nullable(),doneAt:d.date().nullable(),canceledAt:d.date().nullable()}).merge(ee).merge(ut).merge(me).strict(),ia=d.object({date:d.number(),time:d.number(),method:d.string(),path:d.string(),statusCode:d.number()}).merge(ee),na=d.object({message:d.string(),stack:d.string().nullable(),statusCode:d.number(),isOperational:d.boolean(),handler:d.enum(S.ERROR.HANDLERS)}).merge(ee);var qt={};K(qt,{CategoryId:()=>ca,OrderId:()=>la,ProductId:()=>Mt,StoreId:()=>vt});import{z as fe}from"zod";var{REQUEST:{PARAMS:pt}}=S,{MIN:Vt}=A.LENGTH,vt=fe.object({[pt.ID.STORE]:fe.string().trim().min(Vt.REQUIRED).uuid()}),ca=fe.object({[pt.ID.CATEGORY]:fe.string().trim().min(Vt.REQUIRED).uuid()}),Mt=fe.object({[pt.ID.PRODUCT]:fe.string().trim().min(Vt.REQUIRED).uuid()}),la=fe.object({[pt.ID.ORDER]:fe.coerce.number().min(0)});var Kt={};K(Kt,{Access:()=>qr,Csrf:()=>vr,Passport:()=>Mr,Session:()=>da});import{z as Re}from"zod";var vr=Re.object({secret:Re.string().trim().min(1)}).strict().optional(),Mr=Re.object({user:Re.string().trim().min(1).uuid()}).strict().optional(),qr=Re.object({key:Re.string().trim().min(1),iv:Re.string().trim().min(1)}).strict().optional(),da=Re.object({csrf:vr,passport:Mr,access:qr}).strict();import{z as we}from"zod";var{MIN:ua}=A.LENGTH,Kr={isUUID:we.string().trim().min(ua.REQUIRED).uuid(),isNullish:we.unknown().nullish(),toBoolean:we.coerce.boolean(),toString:we.coerce.string(),toBigint:we.coerce.bigint(),toNumber:we.coerce.number(),toDate:we.coerce.date()};import{z as te}from"zod";var{MAX:Br,MIN:Bt,PASSWORD:Yr}=A.LENGTH,kr={SignUp:{Body:te.object({username:te.string().trim().min(Bt.REQUIRED).max(Br.USER.USERNAME),email:te.string().trim().min(Bt.REQUIRED).email().max(Br.USER.EMAIL),password:te.string().trim().min(Yr),theme:te.enum(P.THEMES),locale:te.enum(P.LOCALE)})},VerifyEmail:{Query:te.object({token:te.string().trim().min(Bt.REQUIRED).uuid()})},ForgotPassword:{Body:te.object({password:te.string().trim().min(Yr)})}};import{z as Fe}from"zod";var{MIN:mt,LIMIT:jr}=A.LENGTH,zr={Search:{Query:Fe.object({s:Fe.string().trim().min(mt.REQUIRED),limit:Fe.coerce.number().min(mt.REQUIRED).default(jr)})},Stores:{Query:Fe.object({lastStoreId:Fe.string().trim().min(mt.REQUIRED).uuid().optional(),limit:Fe.coerce.number().min(mt.REQUIRED).default(jr)})},Home:{Params:vt}};import{z as se}from"zod";import{z as he}from"zod";var Hr={Create:{Body:he.object({orders:he.array(he.object({quantity:he.coerce.number().min(0),totalPrice:he.coerce.number().min(0)}).merge(Mt))})},Update:{Query:he.object({quantity:he.coerce.number().min(1)})}};var{MIN:Qr,MAX:$r}=A.LENGTH,Jr={Setting:{Body:se.object({theme:se.enum(P.THEMES),locale:se.enum(P.LOCALE),forceTheme:se.coerce.boolean(),disableAnimations:se.coerce.boolean()})},BecomeSeller:{Body:se.object({name:se.string().trim().min(Qr.REQUIRED).max($r.STORE.NAME)})},Update:{Body:se.object({username:se.string().trim().min(Qr.REQUIRED).max($r.USER.USERNAME)})},orders:Hr};import{z as eo}from"zod";import{z as ae}from"zod";var{MIN:ft,MAX:Rt,LIMIT:pa}=A.LENGTH,Wr={All:{Query:ae.object({page:ae.coerce.number().min(1),limit:ae.coerce.number().min(1).default(pa)})},Create:{Body:ae.object({name:ae.string().trim().min(ft.REQUIRED).max(Rt.CATEGORY.NAME),nameAr:ae.string().trim().min(ft.REQUIRED).max(Rt.CATEGORY.NAME)})},Update:{Body:ae.object({name:ae.string().trim().min(ft.REQUIRED).max(Rt.CATEGORY.NAME),nameAr:ae.string().trim().min(ft.REQUIRED).max(Rt.CATEGORY.NAME)})}};import{z as U}from"zod";var{QUALITY:Zr}=P,{MIN:ie,MAX:Ee}=A.LENGTH,Xr={Create:{Body:U.object({title:U.string().trim().min(ie.REQUIRED).max(Ee.PRODUCT.TITLE),titleAr:U.string().trim().min(ie.REQUIRED).max(Ee.PRODUCT.TITLE),description:U.string().trim().max(Ee.PRODUCT.DESCRIPTION),descriptionAr:U.string().trim().max(Ee.PRODUCT.DESCRIPTION),quality:U.enum(Zr),stock:U.coerce.number().min(ie.REQUIRED),price:U.coerce.number().min(ie.REQUIRED),discount:U.coerce.number().min(0).max(100),categoryId:U.string().trim().min(ie.REQUIRED).uuid(),infos:U.string().trim(),sizes:U.string().trim(),tags:U.string().trim(),colors:U.string().trim()})},Update:{Body:U.object({title:U.string().trim().min(ie.REQUIRED).max(Ee.PRODUCT.TITLE),titleAr:U.string().trim().min(ie.REQUIRED).max(Ee.PRODUCT.TITLE),description:U.string().trim().max(Ee.PRODUCT.DESCRIPTION),descriptionAr:U.string().trim().max(Ee.PRODUCT.DESCRIPTION),quality:U.enum(Zr),stock:U.coerce.number().min(0),price:U.coerce.number().min(ie.REQUIRED),discount:U.coerce.number().min(0).max(100),categoryId:U.string().trim().min(ie.REQUIRED).uuid(),deletedImages:U.string().trim(),infos:U.string().trim(),sizes:U.string().trim(),tags:U.string().trim(),colors:U.string().trim()})}};var{MIN:ma,MAX:fa}=A.LENGTH,to={Update:{Body:eo.object({name:eo.string().trim().min(ma.REQUIRED).max(fa.STORE.NAME)})},categories:Wr,products:Xr};var ro={};var oo={store:to,admin:ro};var so={auth:kr,user:Jr,store:zr,dashboard:oo};import{z as Ge}from"zod";var{PASSWORD:ao,MIN:Ra}=A.LENGTH,io={Email:{Middleware:{Body:Ge.object({code:Ge.string().length(6),password:Ge.string().trim().min(ao),confirmPassword:Ge.string().trim().min(ao)})},Body:Ge.object({email:Ge.string().trim().min(Ra.REQUIRED).email()})}};import{z as no}from"zod";var{MIN:Ea}=A.LENGTH,co={Email:{Body:no.object({email:no.string().trim().min(Ea.REQUIRED).email()})}};import{z as ye}from"zod";var{MIN:je,MAX:ze}=A.LENGTH,lo={Name:{Body:ye.object({name:ye.string().trim().min(je.REQUIRED).max(ze.STORE.NAME)})},Category:{Body:ye.object({name:ye.string().trim().min(je.REQUIRED).max(ze.CATEGORY.NAME),nameAr:ye.string().trim().min(je.REQUIRED).max(ze.CATEGORY.NAME)})},Product:{Body:ye.object({title:ye.string().trim().min(je.REQUIRED).max(ze.PRODUCT.TITLE),titleAr:ye.string().trim().min(je.REQUIRED).max(ze.PRODUCT.TITLE)})}};import{z as uo}from"zod";var{MIN:ya}=A.LENGTH,po={Token:{Body:uo.object({code:uo.string().trim().min(ya.REQUIRED)})}};var mo={access:po,user:co,store:lo};var fo={access:io,validate:mo};var Ro={api:so,security:fo};var E={db:Gt,id:qt,session:Kt,req:Ro,validators:Kr};import{getReasonPhrase as Ka,StatusCodes as Ba}from"http-status-codes";import{readFile as Ia,writeFile as Ta}from"fs/promises";import Yt from"node:path";import He from"fluent-ffmpeg";import ga from"sharp";import Oa from"file-type";import{StatusCodes as Na}from"http-status-codes";var{toBoolean:Sa}=E.validators,kt=class{constructor(){}randomFileName(){return Math.round(Date.now()*Math.random())}async bufferToFile(e,s){let r=this.randomFileName(),o=Yt.join(tmp.path,`${r}.${s}`);return await Ta(o,e),o}async fileToBuffer(e){return Ia(e)}},Qe=class extends kt{constructor(...s){super();this.files=[];this.isFfmpegInit=!1;this.cleanTmp=!1;this.files=s}async format(s){return(await Oa.fromBuffer(s))?.ext??""}async ffprobeMetadata(s){return new Promise((r,o)=>{He.ffprobe(s,(a,i)=>Sa.parse(a)?o(a):r(i))})}async toWebp(s){return ga(s).webp({quality:100}).toBuffer()}async initFfmpeg(){if(this.isFfmpegInit)return;let[{path:s},{path:r}]=await Promise.all([import("@ffmpeg-installer/ffmpeg"),import("@ffprobe-installer/ffprobe")]);He.setFfmpegPath(s),He.setFfprobePath(r)}async toMp4(s,r){this.cleanTmp=!0;let o=await this.bufferToFile(s,r),a=Yt.join(tmp.path,`${this.randomFileName()}.mp4`);return new Promise((i,n)=>{He(o).fps(30).videoCodec("libx264").audioCodec("aac").audioQuality(0).format("mp4").output(a).on("end",()=>{this.fileToBuffer(a).then(i).catch(n)}).on("error",n).run()})}async toMp3(s,r){this.cleanTmp=!0;let o=await this.bufferToFile(s,r),a=Yt.join(tmp.path,`${this.randomFileName()}.mp3`);return new Promise((i,n)=>{He(o).audioCodec("libmp3lame").audioBitrate("128k").format("mp3").output(a).on("end",()=>{this.fileToBuffer(a).then(i).catch(n)}).on("error",n).run()})}async toGlb(s){return s}async fileType(s){let r=await this.format(s),o;if(dt.IMAGE.includes(r))o="image";else if(r==="glb")o="model";else if(dt.VIDEO.includes(r)){o="video";let a=await this.bufferToFile(s,r),i=await this.ffprobeMetadata(a);if(Math.floor(i.format.duration??1/0)>60)return null}else if(dt.AUDIO.includes(r)){o="audio";let a=await this.bufferToFile(s,r),i=await this.ffprobeMetadata(a);if(Math.floor(i.format.duration??1/0)>60)return null}else return null;return{buffer:s,type:o,originalExt:r}}async fileConvert(s){let r=s.map(async o=>{switch(o.type){case"image":o.buffer=await this.toWebp(o.buffer);break;case"video":await this.initFfmpeg(),o.buffer=await this.toMp4(o.buffer,o.originalExt);break;case"audio":await this.initFfmpeg(),o.buffer=await this.toMp3(o.buffer,o.originalExt);break;case"model":o.buffer=await this.toGlb(o.buffer);break;default:throw l.server(Na.INTERNAL_SERVER_ERROR,"File converter unhandled convert case")}return o});return Promise.all(r)}async convert(){let s=this.files.map(i=>this.fileType(i)),o=(await Promise.all(s)).filter(i=>i!==null),a=await this.fileConvert(o);return this.cleanTmp&&await tmp.cleanup(),a}};import{rm as Aa,writeFile as wa}from"node:fs/promises";import{randomUUID as ha}from"node:crypto";import jt from"node:path";import{StatusCodes as Ua}from"http-status-codes";var{PUBLIC:Eo,UPLOAD:Pa}=S.GLOBAL,$e=class{constructor(...e){this.files=e}generateUniqueFileName(e){let{nowInSecond:s}=R.fn;return s()+"_"+ha()+"."+e}async write(e){let s=null;switch(e.type){case"image":s="webp";break;case"video":s="mp4";break;case"audio":s="mp3";break;case"model":s="glb";break;default:throw l.server(Ua.INTERNAL_SERVER_ERROR,"File uploader unhandled write case (ext)")}let r=jt.join(Pa,e.type,this.generateUniqueFileName(s)),o=jt.join(__root,Eo,r);return await wa(o,e.buffer),"/"+r}async upload(){return Promise.all(this.files.map(e=>this.write(e)))}static async remove(...e){await Promise.all(e.map(s=>Aa(jt.join(__root,Eo,s),{force:!0})))}};var yo={FileConverter:Qe,FileUploader:$e};import{createTransport as ba}from"nodemailer";var Je=class{constructor(e,s,r){this.options={transport:{service:"gmail",auth:{user:Y.MAIL.USER,pass:Y.MAIL.PASS}}};this.transport=ba(this.options.transport),this.to=e,this.subject=s,this.html=r}async send(){await this.transport.sendMail({to:this.to,subject:this.subject,html:this.html}),this.transport.close()}static errorTemplate(e){return`
      <pre>
        ${JSON.stringify(e,null,4)}
      </pre>
    `}};var q={file:yo,Mail:Je};var tr={};K(tr,{Category:()=>ne,CategoryViewer:()=>Qt,Order:()=>er,Product:()=>_,ProductColor:()=>Zt,ProductImage:()=>Jt,ProductInfo:()=>$t,ProductRating:()=>Et,ProductSize:()=>Wt,ProductTag:()=>Ze,ProductViewer:()=>Xt,ResponseTime:()=>Ca,ServerError:()=>Da,Store:()=>H,StoreLink:()=>zt,StoreSetting:()=>To,StoreViewer:()=>Ht,Tag:()=>We,User:()=>B,UserSetting:()=>Io});import{DataTypes as c}from"sequelize";var{ID:p,TABLES:G,MODELS:g}=S.DB,{MAX:L}=A.LENGTH,B=sequelize.define(g.USER.MODEL,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.UUID,defaultValue:c.UUIDV4},username:{type:c.STRING(L.USER.USERNAME),allowNull:!1},email:{type:c.STRING(L.USER.EMAIL),allowNull:!1,unique:!0},emailVerified:{type:c.DATE,allowNull:!0},password:{type:c.STRING(L.USER.PASSWORD),allowNull:!1},image:{type:c.STRING(L.IMAGE),allowNull:!1,unique:!0}},{tableName:G.USER.TABLE,timestamps:!0,paranoid:!0});B.addHook("afterDestroy",async t=>{await Promise.all([H.destroy({force:!1,where:{userId:t.dataValues.id}})])});var Io=sequelize.define(g.USER.SETTING,{[p.FOREIGN_KEY.USER]:{primaryKey:!0,type:c.UUID,references:{model:B,key:"id"}},theme:{type:c.ENUM(...P.THEMES),defaultValue:P.THEMES[0],allowNull:!1},locale:{type:c.ENUM(...P.LOCALE),defaultValue:P.LOCALE[0],allowNull:!1},forceTheme:{type:c.BOOLEAN,defaultValue:!1,allowNull:!1},disableAnimations:{type:c.BOOLEAN,defaultValue:!1,allowNull:!1}},{tableName:G.USER.SETTING,timestamps:!0});B.hasOne(Io,{foreignKey:p.FOREIGN_KEY.USER,as:g.USER.SETTING});var H=sequelize.define(g.STORE.MODEL,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.UUID,defaultValue:c.UUIDV4},name:{type:c.STRING(L.STORE.NAME),unique:!0,allowNull:!1},image:{type:c.STRING(L.IMAGE),allowNull:!1},[p.FOREIGN_KEY.USER]:{type:c.UUID,allowNull:!1,unique:!0,references:{model:B,key:"id"}}},{tableName:G.STORE.TABLE,timestamps:!0,paranoid:!0});B.hasOne(H,{foreignKey:p.FOREIGN_KEY.USER,as:g.STORE.MODEL});H.addHook("afterDestroy",async t=>{await Promise.all([zt.destroy({force:!1,where:{storeId:t.dataValues.id}}),ne.destroy({force:!1,where:{storeId:t.dataValues.id}})])});var To=sequelize.define(g.STORE.SETTING,{[p.FOREIGN_KEY.STORE]:{primaryKey:!0,type:c.UUID,references:{model:H,key:"id"}}},{tableName:G.STORE.SETTING,timestamps:!0});H.hasOne(To,{foreignKey:p.FOREIGN_KEY.STORE,as:g.STORE.SETTING});var zt=sequelize.define(g.STORE.LINK,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.UUID,defaultValue:c.UUIDV4},platform:{type:c.ENUM(...P.PLATFORMS),allowNull:!1},link:{type:c.STRING(L.STORE.LINK),allowNull:!1},[p.FOREIGN_KEY.STORE]:{type:c.UUID,allowNull:!1,references:{model:H,key:"id"}}},{tableName:G.STORE.LINK,timestamps:!0,paranoid:!0});H.hasMany(zt,{foreignKey:p.FOREIGN_KEY.STORE,as:g.STORE.LINK});var Ht=sequelize.define(g.STORE.VIEWER,{[p.PRIMARY_KEY.ID]:{type:c.BIGINT.UNSIGNED,autoIncrement:!0,allowNull:!0,primaryKey:!0},ip:{type:c.STRING(32),allowNull:!0},[p.FOREIGN_KEY.USER]:{type:c.UUID,allowNull:!0,references:{model:B,key:"id"}},[p.FOREIGN_KEY.STORE]:{type:c.UUID,allowNull:!1,references:{model:H,key:"id"}}},{tableName:G.STORE.VIEWER,createdAt:!0,updatedAt:!1});H.hasMany(Ht,{foreignKey:p.FOREIGN_KEY.STORE,as:g.STORE.VIEWER});B.hasMany(Ht,{foreignKey:p.FOREIGN_KEY.USER,as:g.STORE.SETTING});var ne=sequelize.define(g.CATEGORY.MODEL,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.UUID,defaultValue:c.UUIDV4},name:{type:c.STRING(L.CATEGORY.NAME),allowNull:!1},nameAr:{type:c.STRING(L.CATEGORY.NAME),allowNull:!1},image:{type:c.STRING(L.IMAGE),allowNull:!1},[p.FOREIGN_KEY.STORE]:{type:c.UUID,allowNull:!1,references:{model:H,key:"id"}}},{tableName:G.CATEGORY.TABLE,timestamps:!0,paranoid:!0});H.hasMany(ne,{foreignKey:p.FOREIGN_KEY.STORE,as:g.CATEGORY.MODEL});ne.addHook("afterDestroy",async t=>{await Promise.all([_.destroy({force:!1,where:{categoryId:t.dataValues.id}})])});var Qt=sequelize.define(g.CATEGORY.VIEWER,{[p.PRIMARY_KEY.ID]:{type:c.BIGINT.UNSIGNED,autoIncrement:!0,allowNull:!0,primaryKey:!0},ip:{type:c.STRING(32),allowNull:!0},[p.FOREIGN_KEY.USER]:{type:c.UUID,allowNull:!0,references:{model:B,key:"id"}},[p.FOREIGN_KEY.CATEGORY]:{type:c.UUID,allowNull:!1,references:{model:ne,key:"id"}}},{tableName:G.CATEGORY.VIEWER,createdAt:!0,updatedAt:!1});ne.hasMany(Qt,{foreignKey:p.FOREIGN_KEY.CATEGORY,as:g.CATEGORY.VIEWER});B.hasMany(Qt,{foreignKey:p.FOREIGN_KEY.USER,as:g.CATEGORY.VIEWER});var _=sequelize.define(g.PRODUCT.MODEL,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.UUID,defaultValue:c.UUIDV4},title:{type:c.STRING(L.PRODUCT.TITLE),allowNull:!1},titleAr:{type:c.STRING(L.PRODUCT.TITLE),allowNull:!1},description:{type:c.STRING(L.PRODUCT.DESCRIPTION),allowNull:!0},descriptionAr:{type:c.STRING(L.PRODUCT.DESCRIPTION),allowNull:!0},quality:{type:c.ENUM(...P.QUALITY),allowNull:!1},stock:{type:c.SMALLINT.UNSIGNED,allowNull:!1},model:{type:c.STRING(L.PRODUCT.MODEL),allowNull:!0},price:{type:c.DOUBLE.UNSIGNED,allowNull:!1},discount:{type:c.DOUBLE.UNSIGNED,allowNull:!1,defaultValue:0},[p.FOREIGN_KEY.CATEGORY]:{type:c.UUID,allowNull:!1,references:{model:ne,key:"id"}}},{tableName:G.PRODUCT.TABLE,timestamps:!0,paranoid:!0});_.belongsTo(ne,{foreignKey:p.FOREIGN_KEY.CATEGORY,as:g.CATEGORY.MODEL});ne.hasMany(_,{foreignKey:p.FOREIGN_KEY.CATEGORY,as:g.PRODUCT.MODEL});_.addHook("afterDestroy",async t=>{await Promise.all([$t.destroy({force:!1,where:{productId:t.dataValues.id}}),Jt.destroy({force:!1,where:{productId:t.dataValues.id}}),Zt.destroy({force:!1,where:{productId:t.dataValues.id}}),Wt.destroy({force:!1,where:{productId:t.dataValues.id}}),Et.destroy({force:!1,where:{productId:t.dataValues.id}}),Ze.destroy({force:!1,where:{productId:t.dataValues.id}})])});var $t=sequelize.define(g.PRODUCT.INFO,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.BIGINT.UNSIGNED,autoIncrement:!0},info:{type:c.STRING(L.PRODUCT.INFO),allowNull:!1},infoAr:{type:c.STRING(L.PRODUCT.INFO),allowNull:!1},[p.FOREIGN_KEY.PRODUCT]:{type:c.UUID,allowNull:!1,references:{model:_,key:"id"}}},{tableName:G.PRODUCT.INFO,timestamps:!0,paranoid:!0});_.hasMany($t,{foreignKey:p.FOREIGN_KEY.PRODUCT,as:g.PRODUCT.INFO});var Jt=sequelize.define(g.PRODUCT.IMAGE,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.BIGINT.UNSIGNED,autoIncrement:!0},image:{type:c.STRING(L.IMAGE),allowNull:!1},[p.FOREIGN_KEY.PRODUCT]:{type:c.UUID,allowNull:!1,references:{model:_,key:"id"}}},{tableName:G.PRODUCT.IMAGE,createdAt:!0,updatedAt:!1,paranoid:!0});_.hasMany(Jt,{foreignKey:p.FOREIGN_KEY.PRODUCT,as:g.PRODUCT.IMAGE});var Et=sequelize.define(g.PRODUCT.RATING,{[p.FOREIGN_KEY.USER]:{primaryKey:!0,type:c.UUID,allowNull:!1,references:{model:B,key:"id"}},[p.FOREIGN_KEY.PRODUCT]:{primaryKey:!0,type:c.UUID,allowNull:!1,references:{model:_,key:"id"}},rate:{type:c.ENUM(...P.RATING_STARS),allowNull:!1},comment:{type:c.STRING(L.PRODUCT.COMMENT),allowNull:!0}},{tableName:G.PRODUCT.RATING,timestamps:!0,paranoid:!0});_.hasMany(Et,{foreignKey:p.FOREIGN_KEY.PRODUCT,as:g.PRODUCT.RATING});B.hasMany(Et,{foreignKey:p.FOREIGN_KEY.USER,as:g.PRODUCT.RATING});var Wt=sequelize.define(g.PRODUCT.SIZE,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.BIGINT.UNSIGNED,autoIncrement:!0},size:{type:c.STRING(L.PRODUCT.SIZE),validate:{is:/\b((xs|s|m|l|xl)|([2-9](xs|xl)))\b/i},allowNull:!1},[p.FOREIGN_KEY.PRODUCT]:{type:c.UUID,allowNull:!1,references:{model:_,key:"id"}}},{tableName:G.PRODUCT.SIZE,createdAt:!0,updatedAt:!1,paranoid:!0});_.hasMany(Wt,{foreignKey:p.FOREIGN_KEY.PRODUCT,as:g.PRODUCT.SIZE});var Zt=sequelize.define(g.PRODUCT.COLOR,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.BIGINT.UNSIGNED,autoIncrement:!0},color:{type:c.STRING(L.PRODUCT.COLOR),allowNull:!1},[p.FOREIGN_KEY.PRODUCT]:{type:c.UUID,allowNull:!1,references:{model:_,key:"id"}}},{tableName:G.PRODUCT.COLOR,createdAt:!0,updatedAt:!1,paranoid:!0});_.hasMany(Zt,{foreignKey:p.FOREIGN_KEY.PRODUCT,as:g.PRODUCT.COLOR});var Xt=sequelize.define(g.PRODUCT.VIEWER,{[p.PRIMARY_KEY.ID]:{type:c.BIGINT.UNSIGNED,autoIncrement:!0,allowNull:!1,primaryKey:!0},ip:{type:c.STRING(32),allowNull:!1},[p.FOREIGN_KEY.USER]:{type:c.UUID,allowNull:!0,references:{model:B,key:"id"}},[p.FOREIGN_KEY.PRODUCT]:{type:c.UUID,allowNull:!1,references:{model:_,key:"id"}}},{tableName:G.PRODUCT.VIEWER,createdAt:!0,updatedAt:!1});_.hasMany(Xt,{foreignKey:p.FOREIGN_KEY.PRODUCT,as:g.PRODUCT.VIEWER});B.hasMany(Xt,{foreignKey:p.FOREIGN_KEY.PRODUCT,as:g.PRODUCT.VIEWER});var We=sequelize.define(g.TAG,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.UUID,defaultValue:c.UUIDV4},tag:{type:c.STRING(L.TAG),unique:!0,allowNull:!1},[p.FOREIGN_KEY.STORE]:{type:c.UUID,allowNull:!1,references:{model:H,key:"id"}}},{tableName:G.TAG,createdAt:!0,updatedAt:!1});H.hasMany(We,{foreignKey:p.FOREIGN_KEY.STORE,as:g.TAG});We.addHook("afterDestroy",async t=>{await Promise.all([Ze.destroy({force:!1,where:{tagId:t.dataValues.id}})])});var Ze=sequelize.define(g.PRODUCT.TAG,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.BIGINT.UNSIGNED,autoIncrement:!0},[p.FOREIGN_KEY.TAG]:{type:c.UUID,allowNull:!1,references:{model:We,key:"id"}},[p.FOREIGN_KEY.PRODUCT]:{type:c.UUID,allowNull:!1,references:{model:_,key:"id"}}},{tableName:G.PRODUCT.TAG,createdAt:!0,updatedAt:!1,paranoid:!0});_.hasMany(Ze,{foreignKey:p.FOREIGN_KEY.PRODUCT,as:g.PRODUCT.TAG});We.hasMany(Ze,{foreignKey:p.FOREIGN_KEY.TAG,as:g.PRODUCT.TAG});var er=sequelize.define(g.ORDER,{[p.PRIMARY_KEY.ID]:{primaryKey:!0,type:c.BIGINT.UNSIGNED,autoIncrement:!0},quantity:{type:c.SMALLINT.UNSIGNED,allowNull:!1},totalPrice:{type:c.DOUBLE.UNSIGNED,allowNull:!1},status:{type:c.ENUM(...P.ORDER_STATUS),defaultValue:P.ORDER_STATUS[0],allowNull:!1},[p.FOREIGN_KEY.USER]:{type:c.UUID,allowNull:!1,references:{model:B,key:"id"}},[p.FOREIGN_KEY.PRODUCT]:{type:c.UUID,allowNull:!1,references:{model:_,key:"id"}},processedAt:{type:c.DATE,allowNull:!0},doneAt:{type:c.DATE,allowNull:!0},canceledAt:{type:c.DATE,allowNull:!0}},{tableName:G.ORDER,timestamps:!0});_.hasMany(er,{foreignKey:p.FOREIGN_KEY.PRODUCT,as:g.ORDER});B.hasMany(er,{foreignKey:p.FOREIGN_KEY.USER,as:g.ORDER});var Ca=sequelize.define(g.RESPONSE_TIME,{[p.PRIMARY_KEY.ID]:{type:c.BIGINT.UNSIGNED,autoIncrement:!0,primaryKey:!0},date:{type:c.INTEGER.UNSIGNED,allowNull:!1},time:{type:c.FLOAT.UNSIGNED,allowNull:!1},method:{type:c.STRING(10),allowNull:!1},path:{type:c.STRING(255),allowNull:!1},statusCode:{type:c.SMALLINT.UNSIGNED,allowNull:!1}},{tableName:G.RESPONSE_TIME,timestamps:!1,paranoid:!1}),Da=sequelize.define(g.SERVER_ERROR,{[p.PRIMARY_KEY.ID]:{type:c.BIGINT.UNSIGNED,autoIncrement:!0,primaryKey:!0},message:{type:c.STRING(255),allowNull:!1},stack:{type:c.TEXT,allowNull:!0},statusCode:{type:c.SMALLINT.UNSIGNED,allowNull:!1},isOperational:{type:c.BOOLEAN,allowNull:!1},handler:{type:c.ENUM(...S.ERROR.HANDLERS),allowNull:!1}},{tableName:G.SERVER_ERROR,timestamps:!0});var rr={};K(rr,{tableIndex:()=>_a});import{QueryTypes as xa}from"sequelize";var{isUUID:La}=E.validators;async function _a(t,e){let s=La.parse(e);return(await sequelize.query(`
      SELECT row_number FROM (
        SELECT ROW_NUMBER() OVER() AS row_number, id FROM "${t}"
      )
      WHERE id=$id
      LIMIT 1
    `,{type:xa.SELECT,plain:!0,raw:!0,bind:{id:s}}))?.row_number??0}var or={};K(or,{order:()=>Ga,orders:()=>Va});import{QueryTypes as go}from"sequelize";var{LENGTH:Fa}=A,{ORDER_STATUS:Bd}=P,{isUUID:Oo}=E.validators;async function Ga(t){let e=Oo.parse(t);return sequelize.query("",{type:go.SELECT,raw:!1,bind:{parsedId:e}})}async function Va(t,e="all",s=0){let r=Oo.parse(t);return sequelize.query(`
    SELECT
      "Order"."quantity" AS "order.quantity",
      "Order"."totalPrice" AS "order.price",
      "Order"."status" AS "order.status",
      "Product"."title" AS "product.title",
      "Product"."titleAr" AS "product.titleAr",
      "Product"."price" AS "product.price",
      "Product"."discount" AS "product.discount",
      "Product"."description" AS "product.description",
      "Product"."descriptionAr" AS "product.descriptionAr",
      "ProductImage"."image" AS "product.image"
    FROM "Order"
    INNER JOIN "Product" ON "Product"."id" = "Order"."productId"
    INNER JOIN "ProductImage" ON "ProductImage"."productId" = "Product"."id"
    INNER JOIN "User" ON "User"."id" = "Order"."userId"
    WHERE "User"."id" = $id ${e!=="all"?'AND "Order"."status" = $filter':""}
    LIMIT $limit OFFSET $offset
  `,{type:go.SELECT,raw:!0,bind:{id:r,filter:e==="all"?"":e,limit:Fa.LIMIT,offset:s}})}var sr={};K(sr,{withProductsCount:()=>qa});import{QueryTypes as va}from"sequelize";var{isUUID:Ma}=E.validators;async function qa(t,e=!0){let s=Ma.parse(t);return sequelize.query(`
    SELECT "Category"."id", "name", "nameAr", "image", COUNT("Product"."id") AS "count"
    FROM "Category"
    INNER JOIN "Product" ON "Product"."categoryId" = "Category"."id"
    WHERE "Category"."sellerId" = $storeId
    GROUP BY "Category"."id"
    ORDER BY "count" ${e?"DESC":"ASC"}
  `,{type:va.SELECT,raw:!0,bind:{sellerId:s}})}var No={user:or,category:sr};var m={db:tr,fn:rr,query:No};var{toString:Ya}=E.validators,Q=class t extends Error{constructor(e,s,r,o,a){super(s),this.statusCode=e,this.statusText=Ka(this.statusCode),this.handler=r,this.isOperational=o,this.rollback=a,Object.setPrototypeOf(this,new.target.prototype),Error.captureStackTrace(this)}static async handleError(e){if(!IS_PRODUCTION)return;let s=e instanceof Error?e:new Error(Ya.parse(e)),r={message:s.message,stack:(s.stack??"").replaceAll(`
`,"<br/>"),statusCode:Ba.INTERNAL_SERVER_ERROR,isOperational:!1,handler:"server",rollback:null};s instanceof t&&(r.statusCode=s.statusCode,r.handler=s.handler,r.isOperational=s.isOperational,r.rollback=s.rollback);try{let{Mail:o,file:{FileUploader:a}}=q,{ServerError:i}=m.db,n=r.rollback?.files??[];await Promise.all([new o(Y.MAIL.USER,`New error - ${r.isOperational?"Catch":"Urgent"} - Status: ${r.statusCode}`,o.errorTemplate(r)).send(),a.remove(...n),i.create(r,{fields:["message","stack","statusCode","isOperational","handler"]})])}catch{IS_PRODUCTION,process.exit(1)}}static checkOperational(e){return e instanceof t?e.isOperational:!1}},l=class{static controller(e,s="",r=null){return new Q(e,s,"controller",!0,r)}static middleware(e,s="",r=null){return new Q(e,s,"middleware",!0,r)}static socket(e,s="",r=null){return new Q(e,s,"socket",!0,r)}static passport(e,s="",r=null){return new Q(e,s,"passport",!0,r)}static server(e,s="",r=null){return new Q(e,s,"server",!1,r)}};import{StatusCodes as za}from"http-status-codes";var{isUUID:Ao}=E.validators,wo=32,ho=16,Uo="aes-256-cbc",Po={token(t){if(!Ao.parse(t))throw l.server(za.INTERNAL_SERVER_ERROR,"Invalid id type (uuid) to create Access Token");let e=`${t}`,s=So(wo),r=So(ho),o=ka(Uo,s,r),a=o.update(e,"utf8","base64")+o.final("base64"),i=r.toString("hex"),n=s.toString("hex");return{token:a,iv:i.substring(3),key:n.substring(3),code:n.substring(0,3)+i.substring(0,3)}},verify(t,e,s,r){let o=Buffer.from(t,"base64"),a=r.substring(0,3),i=r.substring(3),n=Buffer.from(a+e,"hex"),u=Buffer.from(i+s,"hex");if(u.length!==ho||n.length!==wo)return{valid:!1,id:""};let y=ja(Uo,n,u),O=Buffer.concat([y.update(o),y.final()]).toString();return O===void 0?{valid:!1,id:""}:Ao.parse(O)?{valid:!0,id:O}:{valid:!1,id:""}}};import{hashSync as Ha,genSaltSync as Qa,compareSync as $a}from"bcrypt";var bo={hash:t=>Ha(t,Qa(12)),compare:(t,e)=>$a(t,e)};import Co from"csrf";var Do={generate(){let t=new Co,e=t.secretSync();return{token:t.create(e),secret:e}},verify:(t,e)=>new Co().verify(t,e)};import xo from"jsonwebtoken";var Lo={sign:(t,e=A.TIME.MONTH)=>xo.sign({data:JSON.stringify(t)},Y.JWT.SECRET,{expiresIn:e}),verify(t){let e=null;try{if(e=xo.verify(t,Y.JWT.SECRET),e===null)throw new Error;if(typeof e!="object")throw new Error;if(!("data"in e))throw new Error;if(typeof e.data!="string")throw new Error;e=JSON.parse(e.data)}catch{e=null}return e}};var ar={};K(ar,{getHeader:()=>ei,handleAsync:()=>Za,nowInSecond:()=>Xa});import{MulterError as Ja}from"multer";import{ZodError as Wa}from"zod";import{StatusCodes as _o}from"http-status-codes";function Za(t){return async(e,s,r)=>{let o=await sequelize.transaction();try{await t(e,s,r,o),await o.commit()}catch(a){await Promise.all([Q.handleError(a),o.rollback()]);let i=_o.BAD_REQUEST,n="";if(a instanceof Q)i=a.statusCode,n=a.message;else if(a instanceof Wa)n=a.flatten().formErrors.join(";");else if(a instanceof Ja)i=_o.FORBIDDEN,n=a.message;else return r(a);s.status(i).json({success:!1,message:n})}}}function Xa(t=0){return Math.floor((Date.now()+t)/A.TIME.SECOND)}function ei(t,e){return t[e.toLowerCase()]??""}var R={access:Po,bcrypt:bo,csrf:Do,jwt:Lo,fn:ar};import Fo from"multer";var ir=Fo({storage:Fo.memoryStorage()});ir.none();import ti from"tmp-promise";var Go={async initTmpDir(){global.tmp=await ti.dir({unsafeCleanup:!0})}};import ri from"connect-mongo";import{rateLimit as oi}from"express-rate-limit";import si from"rate-limit-mongo";var{URI:Vo}=Y,{COLLECTIONS:vo}=S.CACHE,{TIME:ai}=A,Mo={initLimiter(){return oi({store:new si({uri:Vo.MONGO,collectionName:vo.RATE_LIMIT,user:"",password:"",expireTimeMs:15*60*1e3,errorHandler:void 0}),limit:1e3,windowMs:ai.MINUTE})},initSession(){return ri.create({mongoUrl:Vo.MONGO,collectionName:vo.SESSION})}};import qo from"swagger-ui-express";import ii from"swagger-jsdoc";import ni from"node:path";var{PACKAGE:Ko}=A,ci=ni.join(__root,"ts/**/*.ts"),li={failOnErrors:!0,definition:{openapi:"3.1.0",info:{title:"LogRocket Express API with Swagger",version:Ko.VERSION,description:"This is a simple CRUD API application made with Express and documented with Swagger",license:{name:"MIT",url:"https://spdx.org/licenses/MIT.html"},contact:{name:"LogRocket",url:"https://logrocket.com",email:"info@email.com"}},servers:[{url:`http://localhost:3000/v${Ko.VERSION}`}]},apis:[ci]},Bo={init(){let t=ii(li),e=qo.setup(t,{explorer:!0});return{json:t,serve:qo.serve,ui:e}}};var nr={};K(nr,{cookieOptions:()=>di});var di={maxAge:9e5,sameSite:IS_PRODUCTION?"none":"strict",httpOnly:IS_PRODUCTION,secure:IS_PRODUCTION,path:"/"};var b={upload:ir,db:Gr,tmp:Go,app:Mo,swagger:Bo,options:nr};import{Router as Pc}from"express";import{Router as lc}from"express";import{Router as an}from"express";var Yo={};import{StatusCodes as Ie}from"http-status-codes";var{StoreId:ui,CategoryId:ko,ProductId:jo}=E.id,zo={async checkStore(t,e,s,r){let{storeId:o}=ui.parse(t.params),{Store:a}=m.db,i=await a.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{id:o},limit:1,plain:!0,transaction:r});if(i===null)throw l.middleware(Ie.NOT_FOUND,"Store not found");return e.locals={...e.locals,store:i},s()},async checkCategory(t,e,s,r){let{categoryId:o}=ko.parse(t.params),{store:a}=e.locals,{Category:i}=m.db,n=await i.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{id:o,storeId:a.dataValues.id},limit:1,plain:!0,transaction:r});if(n===null)throw l.middleware(Ie.NOT_FOUND,"Category not found");return e.locals={...e.locals,category:n},s()},async checkProduct(t,e,s,r){let{productId:o}=jo.parse(t.params),{category:a}=e.locals,{Product:i}=m.db,n=await i.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{id:o,categoryId:a.dataValues.id},limit:1,plain:!0,transaction:r});if(n===null)throw l.middleware(Ie.NOT_FOUND,"Product not found");return e.locals={...e.locals,product:n},s()},async isSeller(t,e,s,r){let{user:o}=t;if(o===void 0)throw l.middleware(Ie.UNAUTHORIZED,"Unauthorized user");let{Store:a}=m.db,i=await a.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{userId:o.dataValues.id},limit:1,plain:!0,transaction:r});if(i===null)throw l.middleware(Ie.NOT_FOUND,"Store not found, you can become seller");return e.locals={...e.locals,store:i},s()},async isCategoryOwner(t,e,s,r){let{categoryId:o}=ko.parse(t.params),{store:a}=e.locals,{Category:i}=m.db,n=await i.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{storeId:a.dataValues.id,id:o},plain:!0,limit:1,transaction:r});if(n===null)throw l.middleware(Ie.NOT_FOUND,"Category not found");return e.locals={...e.locals,category:n},s()},async isProductOwner(t,e,s,r){let{productId:o}=jo.parse(t.params),{store:a}=e.locals,{Category:i}=m.db,n=await i.findAll({attributes:["id"],where:{storeId:a.dataValues.id},transaction:r});if(n.length===0)throw l.middleware(Ie.FORBIDDEN,"This store don't have any categories");let u=n.map(O=>O.dataValues.id),{Product:y}=m.db,I=await y.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{categoryId:u,id:o},limit:1,plain:!0,transaction:r});if(I===null)throw l.middleware(Ie.NOT_FOUND,"Product not found");return e.locals={...e.locals,product:I},s()}};var Ho={async isAdmin(t,e,s){return s()}};var Qo={user:Yo,store:zo,admin:Ho};import{StatusCodes as Ve}from"http-status-codes";var{COOKIE:pi}=S,$o={async access(t,e,s,r){let o=`${t.cookies[pi.TOKEN]??""}`;if(o.length===0)throw l.middleware(Ve.BAD_REQUEST,"Access token not send");let a=t.session.access?.key??"";if(a.length===0)throw l.server(Ve.FORBIDDEN,"Invalid access key");let i=t.session.access?.iv??"";if(i.length===0)throw l.server(Ve.FORBIDDEN,"Invalid access iv");let{Body:n}=E.req.security.access.Email.Middleware,{code:u,password:y,confirmPassword:I}=n.parse(t.body);if(!Object.is(y,I))throw l.controller(Ve.CONFLICT,"Passwords not equal");let{access:O}=R,N=O.verify(o,a,i,u);if(!N.valid)throw l.middleware(Ve.UNAUTHORIZED,"Invalid access token");t.session.access={key:"",iv:""};let{User:x}=m.db,M=await x.findOne({attributes:["id","emailVerified"],where:{id:N.id},plain:!0,limit:1,transaction:r});if(M===null)throw l.middleware(Ve.NOT_FOUND,"User not found");return delete t.body.code,delete t.body.confirmPassword,t.user=M,s()}};var cr={};K(cr,{checkOrder:()=>Ei,isAuthenticated:()=>fi,isSeller:()=>yi,notAuthenticated:()=>Ri});import{StatusCodes as yt}from"http-status-codes";var{OrderId:mi}=E.id;async function fi(t,e,s){if(!t.isAuthenticated())throw l.middleware(yt.UNAUTHORIZED,"Unauthenticated user");return s()}async function Ri(t,e,s){if(t.isAuthenticated())throw l.middleware(yt.NOT_ACCEPTABLE,"User already authenticated");return s()}async function Ei(t,e,s,r){let o=t.user,{orderId:a}=mi.parse(t.params),{Order:i}=m.db,n=await i.findOne({attributes:{exclude:["createdAt","updatedAt"]},where:{id:a,userId:o.dataValues.id},limit:1,plain:!0,transaction:r});if(n===null)throw l.middleware(yt.NOT_FOUND,"Order not found");return e.locals={...e.locals,order:n},s()}async function yi(t,e,s,r){let{user:o}=t,{Store:a}=m.db,i=await a.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{userId:o.dataValues.id},limit:1,plain:!0,transaction:r});if(i===null)throw l.middleware(yt.NOT_FOUND,"Seller not found");return e.locals={...e.locals,store:i},s()}var V={api:Qo,security:$o,fn:cr};import{StatusCodes as $}from"http-status-codes";import{serialize as Xo}from"cookie";import{StatusCodes as Oi}from"http-status-codes";import ce from"passport";import{Strategy as Ii}from"passport-local";import{StatusCodes as Jo}from"http-status-codes";var Wo=new Ii({usernameField:"email",passwordField:"password"},(t,e,s)=>{let{User:r}=m.db;r.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{email:t},limit:1}).then(o=>{if(o===null)return s(l.passport(Jo.NOT_FOUND,"User not found"));let{compare:a}=R.bcrypt;return a(e,o.dataValues.password)?s(null,o):s(l.passport(Jo.UNAUTHORIZED,"Invalid password"))}).catch(s)});import{Strategy as Ti}from"passport-http-bearer";import{StatusCodes as lr}from"http-status-codes";var Zo=new Ti((t,e)=>{let{verify:s}=R.jwt,r=s(t);if(r===null)return e(l.passport(lr.BAD_REQUEST,"Invalid token"));let{isUUID:o}=E.validators,a=o.safeParse(r);if(!a.success)return e(l.passport(lr.BAD_REQUEST,a.error.message));let{User:i}=m.db;i.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{id:a.data},limit:1,plain:!0}).then(n=>n===null?e(l.passport(lr.NOT_FOUND,"User not found")):e(null,n)).catch(e)});var{isUUID:gi}=E.validators;ce.serializeUser((t,e)=>e(null,t.dataValues.id));ce.deserializeUser((t,e)=>{let s=gi.safeParse(t);if(!s.success)return e(null,!1);let{User:r}=m.db;r.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{id:s.data},limit:1}).then(o=>o===null?e(null,!1):e(null,o)).catch(e)});ce.use(Wo);ce.use(Zo);async function dr(t,e,s,r){return new Promise((o,a)=>{ce.authenticate(t,(i,n,u)=>{let{toBoolean:y}=E.validators;if(y.parse(i))return a(i);if(!y.parse(n))return a(l.passport(Oi.BAD_REQUEST,u?.message??"Invalid info"));e.logIn(n,I=>y.parse(I)?a(I):o(n))})(e,s,r)})}var{COOKIE:es}=S,{SignUp:Ni,VerifyEmail:Si,ForgotPassword:Ai}=E.req.api.auth,ts={async signUp(t,e,s,r){let{Body:o}=Ni,{username:a,email:i,password:n,theme:u,locale:y}=o.parse(t.body),{User:I,UserSetting:O}=m.db;if(await I.findOne({attributes:["email"],where:{email:i},limit:1,plain:!0,transaction:r})!==null)throw l.controller($.BAD_REQUEST,"Email already exist");let x=t.file;if(x===void 0||x.buffer.length===0)throw l.controller($.BAD_REQUEST,"Please, provide an image");let{FileConverter:M,FileUploader:w}=q.file,C=await new M(x.buffer).convert();if(C.length===0)throw l.controller($.UNSUPPORTED_MEDIA_TYPE,"Unsupported image format");let pe=await new w(...C).upload();if(pe.length===0)throw l.server($.INTERNAL_SERVER_ERROR,"Can't upload your image");let{hash:De}=R.bcrypt,Be=await I.create({username:a,email:i,password:De(n),image:pe[0]},{fields:["username","email","password","image"],transaction:r});await O.create({userId:Be.dataValues.id,theme:u,locale:y,forceTheme:!1,disableAnimations:!1},{fields:["userId","theme","locale","forceTheme","disableAnimations"],transaction:r}),e.status($.CREATED).json({success:!0})},async signIn(t,e,s,r){let o=await dr("local",t,e,s),{sign:a}=R.jwt,{UserSetting:i,Store:n}=m.db,[u,y]=await Promise.all([i.findOne({attributes:{exclude:["userId"]},where:{userId:o.dataValues.id},plain:!0,limit:1,transaction:r}),n.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{userId:o.dataValues.id},plain:!0,limit:1,transaction:r})]),{options:I}=b;e.status($.OK).setHeader("Set-Cookie",Xo(es.AUTHORIZATION,a(o.dataValues.id),I.cookieOptions)).json({success:!0,data:{user:o.dataValues,setting:u.dataValues,store:y?.dataValues??null}})},async signOut(t,e){t.logOut(s=>{let{toBoolean:r}=E.validators;if(r.parse(s))throw s;t.session.csrf={secret:""},t.session.access={key:"",iv:""},e.status($.OK).json({success:!0})})},async me(t,e,s,r){let o=await dr("bearer",t,e,s),{sign:a}=R.jwt,{UserSetting:i,Store:n}=m.db,[u,y]=await Promise.all([i.findOne({attributes:{exclude:["userId"]},where:{userId:o.dataValues.id},plain:!0,limit:1,transaction:r}),n.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{userId:o.dataValues.id},plain:!0,limit:1,transaction:r})]),{options:I}=b;e.status($.OK).setHeader("Set-Cookie",Xo(es.AUTHORIZATION,a(o.dataValues.id),I.cookieOptions)).json({success:!0,data:{user:o.dataValues,setting:u.dataValues,store:y?.dataValues??null}})},async verifyEmail(t,e,s,r){let{Query:o}=Si,{token:a}=o.parse(t.query),{verify:i}=R.jwt,n=i(a)??"";if(n.length===0)throw l.controller($.BAD_REQUEST,"Invalid token");let{isUUID:u}=E.validators,y=u.parse(n),{User:I}=m.db,[O,N]=await I.update({emailVerified:new Date},{fields:["emailVerified"],where:{id:y},limit:1,returning:!0,transaction:r});if(N.length===0)throw l.controller($.NOT_FOUND,"User not found");e.status($.OK).json({success:!0})},async forgotPassword(t,e,s,r){let o=t.user,{Body:a}=Ai,{password:i}=a.parse(t.body),{hash:n}=R.bcrypt;await o.update({password:n(i),emailVerified:o.dataValues.emailVerified===null?new Date:o.dataValues.emailVerified},{fields:["password","emailVerified"],transaction:r}),e.status($.OK).json({success:!0})}};import{StatusCodes as W}from"http-status-codes";import{StatusCodes as ve}from"http-status-codes";var ur={};K(ur,{all:()=>hi});import{QueryTypes as wi}from"sequelize";async function hi(){return sequelize.query("",{type:wi.SELECT,raw:!0,bind:{}})}var mr={};K(mr,{all:()=>Ui,one:()=>Pi,orders:()=>Ci,viewers:()=>bi});import{QueryTypes as pr}from"sequelize";async function Ui(t,e){return sequelize.query(`
    SELECT "P"."id", "P"."title", "P"."titleAr",
    ARRAY_AGG(DISTINCT "PI"."image") AS "images", COUNT("PV"."id") as "views", COUNT("O"."id") AS "orders"
    FROM "Product" "P"
    INNER JOIN "ProductImage" "PI" ON "PI"."productId" = "P"."id"
    INNER JOIN "Category" "C" ON "C"."id" = "P"."categoryId"
    LEFT JOIN "ProductViewer" "PV" ON "PV"."productId" = "P"."id"
    LEFT JOIN "Order" "O" ON "O"."productId" = "P"."id"
    WHERE "P"."deletedAt" IS NULL AND "PI"."deletedAt" IS NULL AND "C"."deletedAt" IS NULL AND
    "C"."storeId" = $storeId
    GROUP BY "P"."id"
    ORDER BY "P"."createdAt" DESC
  `,{type:pr.SELECT,bind:{storeId:t},raw:!0,transaction:e})}async function Pi(t,e){return sequelize.query(`SELECT "P"."id" AS "product.id", "P"."title" AS "product.title", "P"."titleAr" AS "product.titleAr",
    "P"."description" AS "product.description", "P"."descriptionAr" AS "product.descriptionAr",
    "P"."quality" AS "product.quality", "P"."stock" AS "product.stock", "P"."model" AS "product.model",
    "P"."price" AS "product.price", "P"."discount" AS "product.discount",
    ARRAY_AGG(DISTINCT "PI"."image") AS "product.images", ARRAY_AGG(DISTINCT "PIn"."info") AS "product.infos", ARRAY_AGG(DISTINCT "PIn"."infoAr") AS "product.infosAr",
    ARRAY_AGG(DISTINCT "PC"."color") AS "product.colors", ARRAY_AGG(DISTINCT "PS"."size") AS "product.sizes", ARRAY_AGG(DISTINCT "T"."tag") AS "product.tags",
    "C"."id" AS "category.id", "C"."name" AS "category.name", "C"."nameAr" AS "category.nameAr", "C"."image" AS "category.image"
    FROM "Product" AS "P"
    INNER JOIN "Category" AS "C" ON "C"."id" = "P"."categoryId"
    INNER JOIN "ProductImage" AS "PI" ON "PI"."productId" = "P"."id"
    LEFT JOIN "ProductTag" AS "PT" ON "PT"."productId" = "P"."id"
    LEFT JOIN "ProductColor" AS "PC" ON "PC"."productId" = "P"."id"
    LEFT JOIN "ProductSize" AS "PS" ON "PS"."productId" = "P"."id"
    LEFT JOIN "ProductInfo" AS "PIn" ON "PIn"."productId" = "P"."id"
    LEFT JOIN "Tag" AS "T" ON "T"."id" = "PT"."tagId"
    WHERE "P"."id" = $id AND "P"."deletedAt" IS NULL AND "C"."deletedAt" IS NULL
    AND "PI"."deletedAt" IS NULL AND "PT"."deletedAt" IS NULL AND "PC"."deletedAt" IS NULL  AND "PS"."deletedAt" IS NULL
    AND "PIn"."deletedAt" IS NULL
    GROUP BY "P"."id", "C"."id"
    LIMIT 1`,{type:pr.SELECT,bind:{id:t},raw:!0,nest:!0,plain:!0,transaction:e})}async function bi(t,e){return sequelize.query(`SELECT "U"."id", "U"."username", "U"."image", COUNT("U"."id") AS "views"
    FROM "User" AS "U"
    INNER JOIN "ProductViewer" AS "PV" ON "PV"."userId" = "U"."id"
    WHERE "PV"."productId" = $productId AND "U"."deletedAt" IS NULL
    GROUP BY "U"."id"`,{type:pr.SELECT,bind:{productId:t},raw:!0,transaction:e})}async function Ci(){}var Rr={};K(Rr,{all:()=>Di,one:()=>xi,products:()=>Li});import{QueryTypes as fr}from"sequelize";async function Di(t,e){return sequelize.query(`
    SELECT "C"."id", "C"."name", "C"."nameAr", "C"."image",
    COUNT("P"."id") AS "products", COUNT("CV"."id") AS "views"
    FROM "Category" "C"
    LEFT JOIN "CategoryViewer" "CV" ON "CV"."categoryId" = "C"."id"
    LEFT JOIN "Product" "P" ON "P"."categoryId" = "C"."id" AND "P"."deletedAt" IS NULL
    WHERE "C"."storeId" = $storeId AND "C"."deletedAt" IS NULL
    GROUP BY "C"."id"
    ORDER BY "C"."createdAt" DESC
    `,{type:fr.SELECT,raw:!0,bind:{storeId:t},transaction:e})}async function xi(t,e){return sequelize.query(`
    SELECT "C"."id", "C"."name", "C"."nameAr", "C"."image",
    COUNT("P"."id") AS "products", COUNT("CV"."id") AS "views"
    FROM "Category" "C"
    LEFT JOIN "CategoryViewer" "CV" ON "CV"."categoryId" = "C"."id"
    LEFT JOIN "Product" "P" ON "P"."categoryId" = "C"."id" AND "P"."deletedAt" IS NULL
    WHERE "C"."id" = $id AND "C"."deletedAt" IS NULL
    GROUP BY "C"."id"
    LIMIT 1
    `,{type:fr.SELECT,raw:!0,plain:!0,bind:{id:t},transaction:e})}async function Li(t,e){return sequelize.query(`
    SELECT "P"."id", "P"."title", "P"."titleAr",
    ARRAY_AGG(DISTINCT "PI"."image") AS "images", COUNT("PV"."id") as "views", COUNT("O"."id") AS "orders"
    FROM "Product" "P"
    INNER JOIN "ProductImage" "PI" ON "PI"."productId" = "P"."id"
    LEFT JOIN "ProductViewer" "PV" ON "PV"."productId" = "P"."id"
    LEFT JOIN "Order" "O" ON "O"."productId" = "P"."id"
    WHERE "P"."deletedAt" IS NULL AND "PI"."deletedAt" IS NULL AND "P"."categoryId" = $categoryId
    GROUP BY "P"."id"
    ORDER BY "P"."createdAt" DESC
    `,{type:fr.SELECT,raw:!0,bind:{categoryId:t},transaction:e})}var yr={};K(yr,{user:()=>Er});var Er={};K(Er,{all:()=>_i,one:()=>Fi});import{QueryTypes as rs}from"sequelize";async function _i(t,e){return sequelize.query(`
    SELECT "O"."id" AS "order.id", "O"."quantity" AS "order.quantity",
    "O"."totalPrice" AS "order.totalPrice", "O"."status" AS "order.status",
    "P"."id" AS "product.id", "P"."title" AS "product.title",
    "P"."titleAr" AS "product.titleAr", "P"."description" AS "product.description", 
    "P"."descriptionAr" AS "product.descriptionAr",
    ARRAY_AGG(DISTINCT "PI"."image") AS "product.images"
    FROM "Order" "O"
    INNER JOIN "Product" "P" ON "P"."id" = "O"."productId"
    INNER JOIN "ProductImage" "PI" ON "PI"."productId" = "P"."id"
    WHERE "O"."userId" = $userId
    GROUP BY "O"."id", "P"."id"
  `,{type:rs.SELECT,raw:!0,nest:!0,bind:{userId:t},transaction:e})}async function Fi(t,e,s){return sequelize.query(`
    SELECT "O"."id" AS "order.id", "O"."quantity" AS "order.quantity",
    "O"."totalPrice" AS "order.totalPrice", "O"."status" AS "order.status",
    "P"."id" AS "product.id", "P"."title" AS "product.title",
    "P"."titleAr" AS "product.titleAr", "P"."description" AS "product.description", 
    "P"."descriptionAr" AS "product.descriptionAr",
    ARRAY_AGG(DISTINCT "PI"."image") AS "product.images"
    FROM "Order" "O"
    INNER JOIN "Product" "P" ON "P"."id" = "O"."productId"
    INNER JOIN "ProductImage" "PI" ON "PI"."productId" = "P"."id"
    WHERE "O"."id" = $id AND "O"."userId" = $userId
    GROUP BY "O"."id", "P"."id"
  `,{type:rs.SELECT,raw:!0,plain:!0,nest:!0,bind:{id:t,userId:e},transaction:s})}var Ir={};K(Ir,{stores:()=>Vi,users:()=>Gi});import{QueryTypes as os}from"sequelize";async function Gi(t){return sequelize.query(`
  SELECT COUNT("id") AS "users", "createdAt" FROM "User"
  GROUP BY "createdAt"
  `,{type:os.SELECT,raw:!0,transaction:t})}async function Vi(t){return sequelize.query(`
  SELECT COUNT("id") AS "stores", "createdAt" FROM "Store"
  GROUP BY "createdAt"
  `,{type:os.SELECT,raw:!0,transaction:t})}var ss={stats:Ir};var J={store:ur,category:Rr,product:mr,order:yr,admin:ss};var{Create:vi,Update:Mi}=E.req.api.user.orders,as={async all(t,e,s,r){let o=t.user,{all:a}=J.order.user,i=await a(o.dataValues.id,r);e.status(ve.OK).json({success:!0,data:{orders:i}})},async order(t,e,s,r){let o=t.user,a=e.locals.order,{one:i}=J.order.user,n=await i(a.dataValues.id,o.dataValues.id,r);e.status(ve.OK).json({success:!0,data:{order:n}})},async create(t,e,s,r){let{Body:o}=vi,{orders:a}=o.parse(t.body),i=t.user,{Order:n}=m.db;await n.bulkCreate(a.map(u=>({userId:i.dataValues.id,productId:u.productId,quantity:u.quantity,totalPrice:u.totalPrice})),{fields:["userId","productId","quantity","totalPrice"],transaction:r}),e.status(ve.CREATED).json({success:!0})},async patch(t,e,s,r){let o=e.locals.order;if(o.dataValues.status!==Lt[0])throw l.controller(ve.FORBIDDEN,"Your order is on processing");let{Query:a}=Mi,{quantity:i}=a.parse(t.query);await o.update({quantity:i},{fields:["quantity"],transaction:r}),e.status(ve.OK).json({success:!0,data:{order:o.dataValues}})},async remove(t,e,s,r){await e.locals.order.update({status:Lt[3],canceledAt:new Date},{fields:["status","canceledAt"],transaction:r}),e.status(ve.OK).json({success:!0})}};var{Setting:qi,BecomeSeller:Ki,Update:Bi}=E.req.api.user,is={async profile(t,e,s,r){let{user:o}=t,{UserSetting:a,Store:i}=m.db,[n,u]=await Promise.all([a.findOne({attributes:["theme","locale","forceTheme","disableAnimations"],where:{userId:o.dataValues.id},plain:!0,limit:1,transaction:r}),i.findOne({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{userId:o.dataValues.id},plain:!0,limit:1,transaction:r})]);e.status(W.OK).json({success:!0,data:{user:o.dataValues,setting:n.dataValues,store:u?.dataValues??null}})},async setting(t,e,s,r){let{Body:o}=qi,a=t.user,{theme:i,locale:n,disableAnimations:u,forceTheme:y}=o.parse(t.body),{UserSetting:I}=m.db,[O,N]=await I.update({theme:i,locale:n,disableAnimations:u,forceTheme:y},{where:{userId:a.dataValues.id},fields:["theme","locale","forceTheme","disableAnimations"],returning:!0,transaction:r,limit:1});e.status(W.OK).json({success:!0,data:{setting:N[0].dataValues}})},async becomeSeller(t,e,s,r){let{Body:o}=Ki,{name:a}=o.parse(t.body),{Store:i}=m.db;if(await i.findOne({attributes:["name"],where:{name:a},paranoid:!1,plain:!0,limit:1,transaction:r})!==null)throw l.controller(W.BAD_REQUEST,"Store name already exists");let{user:u}=t;if(await i.findOne({attributes:["userId"],where:{userId:u.dataValues.id},paranoid:!1,plain:!0,limit:1,transaction:r})!==null)throw l.controller(W.BAD_REQUEST,"You have a store already");let I=t.file;if(I===void 0||I.buffer.length===0)throw l.controller(W.BAD_REQUEST,"Please, provide a logo for your store");let{FileConverter:O,FileUploader:N}=q.file,x=await new O(I.buffer).convert();if(x.length===0)throw l.controller(W.UNSUPPORTED_MEDIA_TYPE,"Invalid image format");let M=await new N(...x).upload();if(M.length===0)throw l.server(W.INTERNAL_SERVER_ERROR,"Can't upload your image");let{StoreSetting:w}=m.db,C=await i.create({name:a,image:M[0],userId:u.dataValues.id},{fields:["name","image","userId"],transaction:r}),pe=await w.create({storeId:C.dataValues.id},{fields:["storeId"],transaction:r});e.status(W.CREATED).json({success:!0,data:{store:C.dataValues,setting:pe.dataValues}})},async update(t,e,s,r){let{user:o}=t,{Body:a}=Bi,{username:i}=a.parse(t.body),n=t.file,u="";if(n!==void 0&&n.buffer.length>0){let{FileConverter:y,FileUploader:I}=q.file,O=await new y(n.buffer).convert();if(O.length===0)throw l.controller(W.UNSUPPORTED_MEDIA_TYPE,"Please, provide a valid image");let N=await new I(...O).upload();if(N.length===0)throw l.server(W.INTERNAL_SERVER_ERROR,"Can't upload your image");await I.remove(o.dataValues.image),u=N[0]}await o.update({username:i,image:u||o.dataValues.image},{fields:["username","image"],transaction:r}),e.status(W.OK).json({success:!0,data:{user:o.dataValues}})},async remove(t,e,s,r){await t.user.destroy({force:!1,transaction:r}),e.status(W.OK).json({success:!0})},orders:as};import{Op as It}from"sequelize";import{StatusCodes as Ue}from"http-status-codes";var{Search:Yi,Home:ki}=E.req.api.store,{DB:F}=S,ns={async search(t,e,s,r){let{Query:o}=Yi,{s:a,limit:i}=o.parse(t.query),{Store:n,Category:u,Product:y,ProductImage:I}=m.db,O=a.split(/\s+/).filter(w=>/^[a-zA-Z0-9-]+$/.test(w)).map(w=>({[It.iLike]:`%${w}%`})),[N,x,M]=await Promise.all([y.findAll({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{[It.or]:[...O.map(w=>({title:w})),...O.map(w=>({titleAr:w})),...O.map(w=>({description:w})),...O.map(w=>({descriptionAr:w}))]},include:[{as:F.MODELS.PRODUCT.IMAGE,attributes:["image"],model:I,required:!0,limit:1},{as:F.MODELS.CATEGORY.MODEL,attributes:["storeId"],model:u,required:!0}],order:[["createdAt","DESC"]],limit:i,transaction:r}),u.findAll({attributes:["id","name","nameAr","image","storeId"],where:{[It.or]:[...O.map(w=>({nameAr:w})),...O.map(w=>({name:w}))]},order:[["createdAt","DESC"]],raw:!0,limit:i,transaction:r}),n.findAll({attributes:["id","image","name"],where:{[It.or]:O.map(w=>({name:w}))},order:[["createdAt","DESC"]],raw:!0,limit:i,transaction:r})]);e.status(Ue.OK).json({success:!0,data:{stores:M,categories:x,products:N.map(w=>{let{dataValues:C}=w;return C.image=C[F.MODELS.PRODUCT.IMAGE][0].dataValues.image,delete C[F.MODELS.PRODUCT.IMAGE],C.storeId=C[F.MODELS.CATEGORY.MODEL].dataValues.storeId,delete C[F.MODELS.CATEGORY.MODEL],C})}})},async all(t,e,s,r){let{Store:o}=m.db,a=await o.findAll({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},raw:!0,order:[["createdAt","DESC"]],transaction:r});e.status(Ue.OK).json({success:!0,data:{stores:a}})},async categories(t,e,s,r){let{Category:o}=m.db,a=await o.findAll({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},raw:!0,order:[["createdAr","DESC"]],transaction:r});e.status(Ue.OK).json({success:!0,data:{categories:a}})},async products(t,e,s,r){let{Product:o,ProductImage:a}=m.db,i=await o.findAll({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},include:{as:F.MODELS.PRODUCT.IMAGE,attributes:["image"],model:a,required:!0,limit:1},order:[["createdAt","DESC"]],transaction:r});e.status(Ue.OK).json({success:!0,data:{products:i.map(n=>{let{dataValues:u}=n;return u.image=u[F.MODELS.PRODUCT.IMAGE][0].image,delete u[F.MODELS.PRODUCT.IMAGE],u})}})},async store(t,e,s,r){let{Params:o}=ki,{storeId:a}=o.parse(t.params),{user:i}=t,{StoreViewer:n}=m.db;await n.create({ip:t.clientIp,userId:i?.dataValues.id,storeId:a},{fields:["ip","userId","storeId"],transaction:r});let u=e.locals.store,{Category:y,Product:I,ProductImage:O}=m.db,N=await y.findAll({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},order:[["createdAt","DESC"]],where:{storeId:u.dataValues.id},transaction:r}),x=N.map(w=>w.dataValues.id),M=await I.findAll({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{categoryId:x},order:[["createdAt","DESC"]],transaction:r,include:[{as:F.MODELS.PRODUCT.IMAGE,attributes:["image"],model:O,required:!0,limit:1},{as:F.MODELS.CATEGORY.MODEL,attributes:["storeId"],model:y,required:!0}]});e.status(Ue.OK).json({success:!0,data:{store:u.dataValues,categories:N.map(w=>w.dataValues),products:M.map(w=>{let{dataValues:C}=w;return C.image=C[F.MODELS.PRODUCT.IMAGE][0].dataValues.image,delete C[F.MODELS.PRODUCT.IMAGE],C.storeId=C[F.MODELS.CATEGORY.MODEL].dataValues.storeId,delete C[F.MODELS.CATEGORY.MODEL],C})}})},async category(t,e,s,r){let o=e.locals.category,{user:a}=t,{CategoryViewer:i,Product:n,ProductImage:u,Category:y}=m.db;await i.create({ip:t.clientIp,userId:a?.dataValues.id,categoryId:o.dataValues.id},{fields:["ip","userId","categoryId"],transaction:r});let I=await n.findAll({attributes:{exclude:["createdAt","updatedAt","deletedAt"]},where:{categoryId:o.dataValues.id},order:[["createdAt","DESC"]],transaction:r,include:[{as:F.MODELS.PRODUCT.IMAGE,attributes:["image"],model:u,required:!0,limit:1},{as:F.MODELS.CATEGORY.MODEL,attributes:["storeId"],model:y,required:!0}]});e.status(Ue.OK).json({success:!0,data:{category:o.dataValues,products:I.map(O=>{let{dataValues:N}=O;return N.image=N[F.MODELS.PRODUCT.IMAGE][0].dataValues.image,delete N[F.MODELS.PRODUCT.IMAGE],N.storeId=N[F.MODELS.CATEGORY.MODEL].dataValues.storeId,delete N[F.MODELS.CATEGORY.MODEL],N})}})},async product(t,e,s,r){let o=e.locals.product,{user:a}=t,{ProductViewer:i}=m.db;await i.create({ip:t.clientIp,userId:a?.dataValues.id,productId:o.dataValues.id},{fields:["ip","userId","productId"],transaction:r});let n=await J.product.one(o.dataValues.id,r);e.status(Ue.OK).json({success:!0,data:{product:n}})}};import{Op as $i}from"sequelize";import{StatusCodes as Me}from"http-status-codes";import{StatusCodes as re}from"http-status-codes";var{Create:ji,Update:zi}=E.req.api.dashboard.store.categories,{category:Tr}=J,cs={async all(t,e,s,r){let o=e.locals.store,a=await Tr.all(o.dataValues.id,r);e.status(re.OK).json({success:!0,data:{categories:a}})},async category(t,e,s,r){let o=e.locals.category,[a,i]=await Promise.all([Tr.products(o.dataValues.id,r),Tr.one(o.dataValues.id,r)]);e.status(re.OK).json({success:!0,data:{category:i,products:a}})},async create(t,e,s,r){let{Body:o}=ji,{name:a,nameAr:i}=o.parse(t.body),n=t.file;if(n===void 0||n.buffer.length===0)throw l.controller(re.BAD_REQUEST,"Please, provide a valid image");let{FileConverter:u,FileUploader:y}=q.file,I=await new u(n.buffer).convert();if(I.length===0)throw l.controller(re.UNSUPPORTED_MEDIA_TYPE,"Invalid image");let O=await new y(...I).upload();if(O.length===0)throw l.controller(re.INTERNAL_SERVER_ERROR,"Can't save image");let{store:N}=e.locals,{Category:x}=m.db,M=await x.create({image:O[0],name:a,nameAr:i,storeId:N.dataValues.id},{fields:["image","name","nameAr","storeId"],returning:!0,transaction:r});e.status(re.CREATED).json({success:!0,data:{category:M.dataValues}})},async update(t,e,s,r){let{Body:o}=zi,{name:a,nameAr:i}=o.parse(t.body),{category:n}=e.locals,u=t.file,y=n.dataValues.image;if(u!==void 0&&u.buffer.length>0){let{FileConverter:I,FileUploader:O}=q.file,N=await new I(u.buffer).convert();if(N.length===0)throw l.controller(re.UNSUPPORTED_MEDIA_TYPE,"Please, provide a valid image");let x=await new O(...N).upload();if(x.length===0)throw l.controller(re.INTERNAL_SERVER_ERROR,"Can't save image");y=x[0]}await n.update({name:a,nameAr:i,image:y},{fields:["name","nameAr","image"],transaction:r}),e.status(re.OK).json({success:!0,data:{category:n.dataValues}})},async remove(t,e,s,r){await e.locals.category.destroy({force:!1,transaction:r}),e.status(re.OK).json({success:!0})}};import{StatusCodes as v}from"http-status-codes";var{product:ls}=J,{Create:Hi,Update:Qi}=E.req.api.dashboard.store.products,ds={async all(t,e,s,r){let o=e.locals.store,a=await ls.all(o.dataValues.id,r);e.status(v.OK).json({success:!0,data:{products:a}})},async product(t,e,s,r){let o=e.locals.product,a=await ls.one(o.dataValues.id,r);e.status(v.OK).json({success:!0,data:{...a}})},async create(t,e,s,r){let{Body:o}=Hi,{title:a,titleAr:i,description:n,descriptionAr:u,quality:y,stock:I,price:O,discount:N,categoryId:x,infos:M,tags:w,sizes:C,colors:pe}=o.parse(t.body),De=t.files;if(De===void 0)throw l.controller(v.BAD_REQUEST,"Please, provide images");let{FileConverter:Be,FileUploader:ht}=q.file,{models:rt=[],images:Ye=[]}=De;if(Ye.length===0)throw l.controller(v.BAD_REQUEST,"Please provide at least one image");let xe=await new Be(...rt.map(T=>T.buffer),...Ye.map(T=>T.buffer)).convert();if(xe.length===0)throw l.controller(v.UNSUPPORTED_MEDIA_TYPE,"Invalid provided files");let j=await new ht(...xe).upload();if(j.length===0)throw l.server(v.INTERNAL_SERVER_ERROR,"Can't save your files");let{Product:ot,ProductColor:st,ProductImage:at,ProductSize:it,ProductInfo:nt,ProductTag:Ut,Tag:z}=m.db,X=await ot.create({title:a,titleAr:i,description:n,descriptionAr:u,quality:y,stock:I,price:O,discount:N,categoryId:x,model:j.find(T=>T.endsWith(".glb"))},{fields:["title","titleAr","description","descriptionAr","quality","stock","price","discount","categoryId","model"],returning:!0,transaction:r}).catch(T=>{throw l.server(v.INTERNAL_SERVER_ERROR,T?.message??"Can't create product",{files:j})}),Le=M.split(",").map(T=>T.trim()).filter(T=>T.length>0);if(Le.length%2!==0)throw l.controller(v.BAD_REQUEST,"Please provide both the english and arabic version in infos");let Pt=C.split(",").map(T=>T.trim()).filter(T=>T.length>0),bt=w.split(",").map(T=>T.trim()).filter(T=>T.length>0),Ct=pe.split(",").map(T=>T.trim()).filter(T=>T.length>0),{store:Dt}=e.locals,ct=await Promise.all(bt.map(T=>z.findOrCreate({attributes:["id"],where:{tag:T},fields:["tag","storeId"],defaults:{tag:T,storeId:Dt.dataValues.id},transaction:r}))).catch(T=>{throw l.server(v.INTERNAL_SERVER_ERROR,T?.message??"Can't find or create tag",{files:j})}),lt=[];for(let T=0;T<Le.length;T+=2){let xt=Le[T],qs=Le[T+1];lt.push({info:xt,infoAr:qs,productId:X.dataValues.id})}let f=j.filter(T=>T.endsWith(".webp"));await Promise.all([at.bulkCreate(f.map(T=>({image:T,productId:X.dataValues.id})),{fields:["image","productId"],transaction:r}),nt.bulkCreate(lt,{fields:["info","infoAr","productId"],transaction:r}),st.bulkCreate(Ct.map(T=>({color:T,productId:X.dataValues.id})),{fields:["color","productId"],transaction:r}),it.bulkCreate(Pt.map(T=>({size:T,productId:X.dataValues.id})),{fields:["size","productId"],transaction:r}),Ut.bulkCreate(ct.map(([T])=>({tagId:T.dataValues.id,productId:X.dataValues.id})),{fields:["tagId","productId"],transaction:r})]).catch(T=>{throw l.server(v.INTERNAL_SERVER_ERROR,T?.message??"Can't complete product promises",{files:j})}),e.status(v.CREATED).json({success:!0})},async update(t,e,s,r){let{Body:o}=Qi,{title:a,titleAr:i,description:n,descriptionAr:u,quality:y,stock:I,price:O,discount:N,categoryId:x,deletedImages:M,infos:w,tags:C,sizes:pe,colors:De}=o.parse(t.body),{FileConverter:Be,FileUploader:ht}=q.file,{models:rt=[],images:Ye=[]}=t.files,xe=await new Be(...rt.map(f=>f.buffer),...Ye.map(f=>f.buffer)).convert();if(xe.length===0&&(rt.length>0||Ye.length>0))throw l.controller(v.UNSUPPORTED_MEDIA_TYPE,"Invalid provided files");let j=await new ht(...xe).upload();if(j.length===0&&xe.length>0)throw l.server(v.INTERNAL_SERVER_ERROR,"Can't save your files");let{ProductColor:ot,ProductImage:st,ProductSize:at,ProductInfo:it,ProductTag:nt,Tag:Ut}=m.db,z=e.locals.product;await z.update({title:a,titleAr:i,description:n,descriptionAr:u,quality:y,stock:I,price:O,discount:N,categoryId:x,model:j.find(f=>f.endsWith(".glb"))??z.dataValues.model},{fields:["title","titleAr","description","descriptionAr","quality","stock","price","discount","categoryId","model"],transaction:r}).catch(f=>{throw l.server(v.INTERNAL_SERVER_ERROR,f?.message??"Can't update product",{files:j})}),await Promise.all([it.destroy({force:!1,where:{productId:z.dataValues.id},transaction:r}),ot.destroy({force:!1,where:{productId:z.dataValues.id},transaction:r}),at.destroy({force:!1,where:{productId:z.dataValues.id},transaction:r}),nt.destroy({force:!1,where:{productId:z.dataValues.id},transaction:r}),st.destroy({force:!1,where:{productId:z.dataValues.id,id:M.split(",").map(f=>f.trim()).filter(f=>f.length>0)},transaction:r})]).catch(f=>{throw l.server(v.INTERNAL_SERVER_ERROR,f?.message??"Can't complete delete product promise",{files:j})});let X=w.split(",").map(f=>f.trim()).filter(f=>f.length>0);if(X.length%2!==0)throw l.controller(v.BAD_REQUEST,"Please provide both the english and arabic version in infos");let Le=pe.split(",").map(f=>f.trim()).filter(f=>f.length>0),Pt=C.split(",").map(f=>f.trim()).filter(f=>f.length>0),bt=De.split(",").map(f=>f.trim()).filter(f=>f.length>0),Ct=e.locals.store,Dt=await Promise.all(Pt.map(f=>Ut.findOrCreate({attributes:["id"],where:{tag:f},fields:["tag","storeId"],defaults:{tag:f,storeId:Ct.dataValues.id},transaction:r}))).catch(f=>{throw l.server(v.INTERNAL_SERVER_ERROR,f?.message??"Can't find or create tag",{files:j})}),ct=[];for(let f=0;f<X.length;f+=2){let T=X[f],xt=X[f+1];ct.push({info:T,infoAr:xt,productId:z.dataValues.id})}let lt=j.filter(f=>f.endsWith(".webp"));await Promise.all([st.bulkCreate(lt.map(f=>({image:f,productId:z.dataValues.id})),{fields:["image","productId"],transaction:r}),it.bulkCreate(ct,{fields:["info","infoAr","productId"],transaction:r}),ot.bulkCreate(bt.map(f=>({color:f,productId:z.dataValues.id})),{fields:["color","productId"],transaction:r}),at.bulkCreate(Le.map(f=>({size:f,productId:z.dataValues.id})),{fields:["size","productId"],transaction:r}),nt.bulkCreate(Dt.map(([f])=>({tagId:f.dataValues.id,productId:z.dataValues.id})),{fields:["tagId","productId"],transaction:r})]).catch(f=>{throw l.server(v.INTERNAL_SERVER_ERROR,f?.message??"Can't complete product promises",{files:j})}),e.status(v.OK).json({success:!0})},async remove(t,e,s,r){await e.locals.product.destroy({force:!1,transaction:r}),e.status(v.OK).json({success:!0})}};var{Update:Ji}=E.req.api.dashboard.store,us={async profile(t,e){let{store:s}=e.locals,{Category:r,Product:o}=m.db,a=await r.findAll({attributes:["id"],where:{storeId:s.dataValues.id}}),i=await o.count({attributes:["categoryId"],where:{[$i.or]:{categoryId:a.map(n=>n.dataValues.id)}},group:"categoryId"});e.status(Me.OK).json({success:!0,data:{store:s.dataValues,count:{categories:a.length,products:i}}})},async update(t,e,s,r){let{Body:o}=Ji,{name:a}=o.parse(t.body),{store:i}=e.locals;if(i===void 0)throw l.server(Me.INTERNAL_SERVER_ERROR,"Unprovided local store (seller:update)");let n=i.dataValues.image,u=t.file;if(u!==void 0&&u.buffer.length>0){let{FileConverter:y,FileUploader:I}=q.file,O=await new y(u.buffer).convert();if(O.length===0)throw l.controller(Me.UNSUPPORTED_MEDIA_TYPE,"Invalid image format");let N=await new I(...O).upload();if(N.length===0)throw l.server(Me.INTERNAL_SERVER_ERROR,"Can't upload your image");n=N[0]}await i.update({name:a,image:n},{fields:["name","image"],transaction:r}),e.status(Me.OK).json({success:!0,data:{store:i.dataValues}})},async remove(t,e,s,r){await e.locals.store.destroy({force:!1,transaction:r}),e.status(Me.OK).json({success:!0})},categories:cs,products:ds};import{StatusCodes as ps}from"http-status-codes";var ms={async users(t,e,s,r){let{stats:o}=J.admin,a=await o.users(r);e.status(ps.OK).json({success:!0,data:{users:a}})},async stores(t,e,s,r){let{stats:o}=J.admin,a=await o.stores(r);e.status(ps.OK).json({success:!0,data:{stores:a}})},async orders(){},async products(){},async categories(){}};var fs={stats:ms};var Rs={store:us,admin:fs};var Es={auth:ts,user:is,stores:ns,dashboard:Rs};import{StatusCodes as ys}from"http-status-codes";var{COOKIE:Wi}=S,{Email:Zi}=E.req.security.access,Is={async email(t,e,s,r){let{Body:o}=Zi,{User:a}=m.db,{email:i}=o.parse(t.body),n=await a.findOne({attributes:["id"],where:{email:i},limit:1,transaction:r});if(n===null)throw l.controller(ys.NOT_FOUND,"user not found");let{access:u}=R,{token:y,code:I,key:O,iv:N}=u.token(n.dataValues.id);t.session.access={key:O,iv:N};let{cookieOptions:x}=b.options;e.cookie(Wi.TOKEN,y,x);let{Mail:M}=q;await new M(i,"access code",`Code: ${I}`).send(),e.status(ys.CREATED).json({success:!0})}};import{StatusCodes as Ts}from"http-status-codes";var{Email:Xi}=E.req.security.validate.user,gs={async email(t,e,s,r){let{Body:o}=Xi,{email:a}=o.parse(t.body),{User:i}=m.db;if(await i.findOne({attributes:["email"],where:{email:a},limit:1,plain:!0,paranoid:!1,transaction:r})!==null)throw l.controller(Ts.CONFLICT,"Email already exists");e.status(Ts.OK).json({success:!0})}};import{StatusCodes as Te}from"http-status-codes";var{Name:en,Category:tn,Product:rn}=E.req.security.validate.store,Os={async name(t,e,s,r){let{Body:o}=en,{name:a}=o.parse(t.body),{Store:i}=m.db;if(await i.findOne({attributes:["name"],where:{name:a},limit:1,plain:!0,paranoid:!1,transaction:r})!==null)throw l.controller(Te.CONFLICT,"Store name already exists");e.status(Te.OK).json({success:!0})},async category(t,e,s,r){let{Body:o}=tn,{name:a,nameAr:i}=o.parse(t.body),n=e.locals.store,{Category:u}=m.db,[y,I]=await Promise.all([u.findOne({attributes:["name"],where:{name:a,storeId:n.dataValues.id},limit:1,plain:!0,paranoid:!1,transaction:r}),u.findOne({attributes:["nameAr"],where:{nameAr:i,storeId:n.dataValues.id},limit:1,plain:!0,paranoid:!1,transaction:r})]);if(y!==null)throw l.controller(Te.CONFLICT,"Category name already exists");if(I!==null)throw l.controller(Te.CONFLICT,"Category arabic name already exists");e.status(Te.OK).json({success:!0})},async product(t,e,s,r){let{Body:o}=rn,{title:a,titleAr:i}=o.parse(t.body),{Product:n}=m.db,[u,y]=await Promise.all([n.findOne({attributes:["title"],where:{title:a},limit:1,plain:!0,paranoid:!1,transaction:r}),n.findOne({attributes:["titleAr"],where:{titleAr:i},limit:1,plain:!0,paranoid:!1,transaction:r})]);if(u!==null)throw l.controller(Te.CONFLICT,"Product name already exists");if(y!==null)throw l.controller(Te.CONFLICT,"Product arabic name already exists");e.status(Te.OK).json({success:!0})}};import{StatusCodes as Xe}from"http-status-codes";var{COOKIE:on}=S,{Token:sn}=E.req.security.validate.access,Ns={async token(t,e){let s=`${t.cookies?.[on.TOKEN]??""}`;if(s.length===0)throw l.controller(Xe.BAD_REQUEST,"Empty access token");let r=t.session.access?.key??"";if(r.length===0)throw l.server(Xe.FORBIDDEN,"Invalid access key");let o=t.session.access?.iv??"";if(o.length===0)throw l.server(Xe.FORBIDDEN,"Invalid access iv");let{Body:a}=sn,{code:i}=a.parse(t.body),{access:n}=R;if(!n.verify(s,r,o,i).valid)throw l.controller(Xe.FORBIDDEN,"Invalid access token");e.status(Xe.OK).json({success:!0})}};var Ss={access:Ns,user:gs,store:Os};var As={access:Is,validate:Ss};var D={api:Es,security:As};var{upload:gr}=b,{handleAsync:k}=R.fn,{UPLOAD:nn}=S,{fn:{isAuthenticated:cn,notAuthenticated:Tt},security:{access:ln}}=V,{signUp:dn,signIn:un,signOut:pn,me:mn,verifyEmail:fn,forgotPassword:Rn}=D.api.auth,ge=an();ge.post("/sign-up",k(Tt),k(gr.single(nn.IMAGE)),k(dn));ge.post("/sign-in",k(Tt),k(gr.none()),k(un));ge.post("/sign-out",k(cn),k(pn));ge.post("/me",k(Tt),k(mn));ge.put("/verify-email",k(fn));ge.put("/forgot-password",k(Tt),k(gr.none()),k(ln),k(Rn));import{Router as Sn}from"express";import{Router as En}from"express";var{upload:yn}=b,{PARAMS:Or}=S.REQUEST,{checkOrder:Nr}=V.fn,{handleAsync:le}=R.fn,{all:In,order:Tn,create:gn,patch:On,remove:Nn}=D.api.user.orders,Pe=En();Pe.get("/",le(In));Pe.get(`/:${Or.ID.ORDER}`,le(Nr),le(Tn));Pe.post("/",le(yn.none()),le(gn));Pe.patch(`/:${Or.ID.ORDER}`,le(Nr),le(On));Pe.delete(`/:${Or.ID.ORDER}`,le(Nr),le(Nn));var{IMAGE:ws}=S.UPLOAD,{upload:Sr}=b,{handleAsync:Oe}=R.fn,{profile:An,setting:wn,becomeSeller:hn,update:Un,remove:Pn}=D.api.user,Ne=Sn();Ne.get("/",Oe(An));Ne.patch("/setting",Oe(Sr.none()),Oe(wn));Ne.post("/become-seller",Oe(Sr.single(ws)),Oe(hn));Ne.put("/",Oe(Sr.single(ws)),Oe(Un));Ne.delete("/",Oe(Pn));Ne.use("/orders",Pe);import{Router as bn}from"express";var{PARAMS:qe}=S.REQUEST,{handleAsync:Z}=R.fn,{checkStore:Ar,checkCategory:hs,checkProduct:Cn}=V.api.store,{search:Dn,all:xn,store:Ln,category:_n,product:Fn}=D.api.stores,de=bn();de.get("/search",Z(Dn));de.get("/",Z(xn));de.get("/categories");de.get("/products");de.get(`/:${qe.ID.STORE}`,Z(Ar),Z(Ln));de.get(`/:${qe.ID.STORE}/:${qe.ID.CATEGORY}`,Z(Ar),Z(hs),Z(_n));de.get(`/:${qe.ID.STORE}/:${qe.ID.CATEGORY}/:${qe.ID.PRODUCT}`,Z(Ar),Z(hs),Z(Cn),Z(Fn));import{Router as ic}from"express";import{Router as Jn}from"express";import{Router as Gn}from"express";var Us=Gn();import{Router as Vn}from"express";var{upload:Ps}=b,{handleAsync:oe}=R.fn,{REQUEST:{PARAMS:wr},UPLOAD:{IMAGE:bs}}=S,{isCategoryOwner:hr}=V.api.store,{all:vn,category:Mn,create:qn,update:Kn,remove:Bn}=D.api.dashboard.store.categories,be=Vn();be.get("/",oe(vn));be.get(`/:${wr.ID.CATEGORY}`,oe(hr),oe(Mn));be.post("/",oe(Ps.single(bs)),oe(qn));be.put(`/:${wr.ID.CATEGORY}`,oe(hr),oe(Ps.single(bs)),oe(Kn));be.delete(`/:${wr.ID.CATEGORY}`,oe(hr),oe(Bn));import{Router as Yn}from"express";var{REQUEST:Ur}=S,{upload:kn}=b,{handleAsync:ue}=R.fn,{isProductOwner:Pr}=V.api.store,{all:jn,product:zn,create:Hn,update:Qn,remove:$n}=D.api.dashboard.store.products,Ce=Yn();Ce.get("/",ue(jn));Ce.get(`/:${Ur.PARAMS.ID.PRODUCT}`,ue(Pr),ue(zn));Ce.post("/",ue(kn.fields([{name:"models",maxCount:1},{name:"images"}])),ue(Hn));Ce.put(`/:${Ur.PARAMS.ID.PRODUCT}`,ue(Pr),ue(Qn));Ce.delete(`/:${Ur.PARAMS.ID.PRODUCT}`,ue(Pr),ue($n));var{upload:Wn}=b,{IMAGE:Zn}=S.UPLOAD,{handleAsync:gt}=R.fn,{profile:Xn,update:ec,remove:tc}=D.api.dashboard.store,Se=Jn();Se.get("/",gt(Xn));Se.put("/",gt(Wn.single(Zn)),gt(ec));Se.delete("/",gt(tc));Se.use("/stats",Us);Se.use("/categories",be);Se.use("/products",Ce);import{Router as ac}from"express";import{Router as rc}from"express";var Ot=rc(),{users:oc,stores:sc}=D.api.dashboard.admin.stats,{handleAsync:Cs}=R.fn;Ot.get("/users",Cs(oc));Ot.get("/stores",Cs(sc));var br=ac();br.use("/stats",Ot);var{handleAsync:Ds}=R.fn,{api:{store:{isSeller:nc},admin:{isAdmin:cc}}}=V,Nt=ic();Nt.use("/store",Ds(nc),Se);Nt.use("/admin",Ds(cc),br);var{isAuthenticated:xs}=V.fn,{handleAsync:Ls}=R.fn,Ke=lc();Ke.use("/auth",ge);Ke.use("/user",Ls(xs),Ne);Ke.use("/stores",de);Ke.use("/dashboard",Ls(xs),Nt);import{Router as Uc}from"express";import{Router as dc}from"express";var{upload:uc}=b,{handleAsync:_s}=R.fn,{email:pc}=D.security.access,Cr=dc();Cr.post("/email",_s(uc.none()),_s(pc));import{Router as Ac}from"express";import{Router as mc}from"express";var{upload:fc}=b,{handleAsync:Dr}=R.fn,{notAuthenticated:Rc}=V.fn,{email:Ec}=D.security.validate.user,xr=mc();xr.post("/email",Dr(Rc),Dr(fc.none()),Dr(Ec));import{Router as yc}from"express";var{upload:Lr}=b,{handleAsync:Ae}=R.fn,{isSeller:Fs}=V.api.store,{name:Ic,category:Tc,product:gc}=D.security.validate.store,et=yc();et.post("/name",Ae(Lr.none()),Ae(Ic));et.post("/category",Ae(Fs),Ae(Lr.none()),Ae(Tc));et.post("/product",Ae(Fs),Ae(Lr.none()),Ae(gc));import{Router as Oc}from"express";var _r=Oc(),{token:Nc}=D.security.validate.access,{handleAsync:Gs}=R.fn,{upload:Sc}=b;_r.post("/token",Gs(Sc.none()),Gs(Nc));var tt=Ac(),{handleAsync:wc}=R.fn,{isAuthenticated:hc}=V.fn;tt.use("/access",_r);tt.use("/user",xr);tt.use("/store",wc(hc),et);var St=Uc();St.use("/validate",tt);St.use("/access",Cr);var At=Pc();At.use("/api",Ke);At.use("/security",St);var h=wt();h.set("env",Y.NODE.ENV);h.set("trust proxy",1);h.disable("x-powered-by");h.disable("view cache");h.enable("json escape");h.enable("etag");var{TIME:Kc,PACKAGE:Bc}=A,{COOKIE:Yc,HTTP:Fr}=S;if(!IS_PRODUCTION){let t=(await import("errorhandler")).default;h.use(t({log:!0}))}var{tmp:kc,app:{initLimiter:jc,initSession:zc},swagger:Hc,options:Qc}=b;await kc.initTmpDir();var vs=Hc.init();h.use(Lc(Kc.MINUTE*5));h.use(Vc(async(t,e,s)=>{let{RESPONSE_TIME:r}=Fr.HEADERS;if(e.setHeader(r,s),IS_PRODUCTION)return;let{method:o,originalUrl:a}=t,{statusCode:i}=e,{ResponseTime:n}=m.db,{nowInSecond:u}=R.fn;await n.create({date:u(),time:s,method:o,path:a,statusCode:i},{fields:["date","time","method","path","statusCode"]})}));h.use(Gc({credentials:!0,origin:(t,e)=>e(null,t)}));h.use(jc());h.use(Vs({level:9,filter(t,e){let{getHeader:s}=R.fn,{NO_COMPRESSION:r}=Fr.HEADERS,o=s(t.headers,r),{toBoolean:a}=E.validators;return a.parse(o)?!1:Vs.filter(t,e)}}));h.use(_c(Fr.HEADERS.METHOD_OVERRIDE));h.use(Dc(IS_PRODUCTION?"combined":"dev"));h.use(wt.urlencoded({extended:!0}));h.use(wt.json({limit:"10mb"}));h.use(Fc(Y.COOKIE.PARSER));h.use(Mc(Y.COOKIE.SECRET));h.use(xc());h.use(bc());h.use(Cc({store:zc(),name:Yc.SESSION,secret:Y.SESSION.SECRET,resave:!1,saveUninitialized:!1,proxy:!0,cookie:Qc.cookieOptions}));h.use(ce.initialize());h.use(ce.session());h.use(vc.mw());h.use(`/v${Bc.VERSION}`,At);h.use(wt.static(qc.join(__root,S.GLOBAL.PUBLIC),{etag:!0}));h.use("/docs",vs.serve,vs.ui);h.all("*",async(t,e)=>e.status(Ms.NOT_FOUND).json({success:!1}));h.use(async(t,e,s,r)=>{await Q.handleError(t),s.status(Ms.INTERNAL_SERVER_ERROR).json({success:!1,message:"Server error"})});process.on("unhandledRejection",t=>{throw t});process.on("uncaughtException",async t=>{await Promise.all([Q.handleError(t),sequelize.close()]),process.exit(1)});var my=h;export{my as default};
